<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Dispositivos em Tempo Real</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: Arial, sans-serif; background-color: #f0f0f0;
        }
        #map { height: 100vh; width: 100vw; }
        .hidden { display: none; }

        /* --- Overlay com Spinner --- */
        #message-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255,255,255,0.95);
            padding: 25px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1001; text-align: center;
            font-size: 1.2em; color: #333;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #ccc;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Controles Inferiores --- */
        #controls-container {
            position: fixed; bottom: 20px; left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column; /* Agora em coluna */
            align-items: flex-start;
            gap: 8px;
            padding: 10px;
            background-color: rgba(255,255,255,0.9);
            border: 1px solid #ccc; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #device-selector {
            font-size: 14px; border-radius: 5px;
            border: 1px solid #ccc; padding: 5px;
            min-width: 220px;
        }
        .map-button {
            background: #3498db; color: white; border: none;
            padding: 6px 10px; border-radius: 5px;
            cursor: pointer; font-size: 14px;
            width: 100%;
        }
        .map-button:hover { background: #2980b9; }

        @media (max-width: 600px) {
            #controls-container { width: 85%; }
            #device-selector, .map-button { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls-container" class="hidden">
        <button id="show-all" class="map-button">üåç Todos</button>
        <select id="device-selector"></select>
    </div>
    <div id="message-overlay">
        <div class="spinner"></div>
        <p>A carregar dispositivos...</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_BASE_URL = 'https://servidor-bot-60dr.onrender.com';
        let map;
        const deviceMarkers = {};
        const messageOverlay = document.getElementById('message-overlay');
        const deviceSelector = document.getElementById('device-selector');
        const controlsContainer = document.getElementById('controls-container');
        const showAllBtn = document.getElementById('show-all');
        let isFirstLoad = true;

        function getUserIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('user_id'); 
        }

        function initializeMap() {
            map = L.map('map').setView([-14.235, -51.925], 4);
            const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: 'Map data ¬© Google'
            }).addTo(map);
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            });
            L.control.layers({ "Google Maps (H√≠brido)": googleHybrid, "OpenStreetMap": osmLayer }).addTo(map);
        }

        // --- √çcone SVG realista de celular ---
        const cellphoneIcon = L.divIcon({
            className: '',
            html: `
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="50" viewBox="0 0 24 24" fill="#3498db" stroke="#2980b9" stroke-width="1.2">
                <rect x="5" y="2" width="14" height="20" rx="2" ry="2" fill="#3498db"/>
                <rect x="7" y="4" width="10" height="14" rx="1" ry="1" fill="#a9d6e5"/>
                <circle cx="12" cy="19" r="1.5" fill="#fff"/>
              </svg>
            `,
            iconSize: [28, 50],
            iconAnchor: [14, 50],
            popupAnchor: [0, -50]
        });

        async function fetchDeviceLocations(userId) {
            if (!userId) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/locations/my_devices/${userId}`);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                const locations = await response.json();
                
                if (isFirstLoad && (!locations || locations.length === 0)) {
                    messageOverlay.innerHTML = `<p>Nenhum dispositivo encontrado.</p>`;
                    return;
                } else if (locations && locations.length > 0) {
                    messageOverlay.classList.add('hidden');
                }
                updateMapMarkers(locations);
            } catch (error) {
                messageOverlay.innerHTML = `<h1>Erro</h1><p>${error.message}</p>`;
                document.getElementById('map').classList.add('hidden');
                controlsContainer.classList.add('hidden');
            }
        }

        function updateMapMarkers(locations) {
            const activeDevices = new Set();
            const markerBounds = [];
            const selectedBefore = deviceSelector.value;
            
            deviceSelector.innerHTML = '<option value="">-- Todos os Dispositivos --</option>';

            locations.forEach(device => {
                const { deviceName, displayName, latitude, longitude, timestamp } = device;
                activeDevices.add(deviceName);
                markerBounds.push([latitude, longitude]);

                const localTimestamp = timestamp ? new Date(timestamp).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }) : 'Sem data';
                const option = document.createElement('option');
                option.value = deviceName;
                option.textContent = `${displayName} ‚Äî ${localTimestamp}`;
                deviceSelector.appendChild(option);

                const latLng = [latitude, longitude];
                const popupContent = `<b>${displayName}</b><br>√öltima atualiza√ß√£o: ${localTimestamp}<br>
                                      <a href="https://www.google.com/maps?q=${latitude},${longitude}" target="_blank">Ver no Google Maps</a>`;

                if (deviceMarkers[deviceName]) {
                    deviceMarkers[deviceName].setLatLng(latLng).setPopupContent(popupContent);
                } else {
                    deviceMarkers[deviceName] = L.marker(latLng, { icon: cellphoneIcon })
                        .addTo(map)
                        .bindPopup(popupContent)
                        .on("click", () => { 
                            deviceSelector.value = deviceName; 
                        });
                }
            });

            for (const deviceName in deviceMarkers) {
                if (!activeDevices.has(deviceName)) {
                    map.removeLayer(deviceMarkers[deviceName]);
                    delete deviceMarkers[deviceName];
                }
            }

            deviceSelector.value = selectedBefore;

            if (isFirstLoad && markerBounds.length > 0) {
                map.fitBounds(markerBounds, { padding: [50, 50] });
                controlsContainer.classList.remove('hidden');
                isFirstLoad = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const userId = getUserIdFromUrl();
            if (!userId) {
                messageOverlay.innerHTML = `<h1>Acesso Inv√°lido</h1>`;
                document.getElementById('map').classList.add('hidden');
                return;
            }
            initializeMap();

            deviceSelector.addEventListener('change', function() {
                const selectedDevice = this.value;
                if (selectedDevice && deviceMarkers[selectedDevice]) {
                    const marker = deviceMarkers[selectedDevice];
                    map.setView(marker.getLatLng(), 16);
                    marker.openPopup();
                } else if (!selectedDevice && Object.keys(deviceMarkers).length > 1) {
                    const allBounds = Object.values(deviceMarkers).map(m => m.getLatLng());
                    map.fitBounds(allBounds, { padding: [50, 50] });
                }
            });

            showAllBtn.addEventListener('click', () => {
                if (Object.keys(deviceMarkers).length > 0) {
                    const allBounds = Object.values(deviceMarkers).map(m => m.getLatLng());
                    map.fitBounds(allBounds, { padding: [50, 50] });
                }
            });

            fetchDeviceLocations(userId);
            setInterval(() => fetchDeviceLocations(userId), 30000);
        });
    </script>
</body>
</html>
